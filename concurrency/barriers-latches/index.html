<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some notes for daily dev for java related"><meta name=author content="Xu Kaixuan"><link href=https://xkx9431.github.io/dev-notes-java/concurrency/barriers-latches/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-7.3.4"><title>使用 Barriers 和 Latches 控制并发的应用程序 - Dev notes for Java</title><link rel=stylesheet href=../../assets/stylesheets/main.db9e7362.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.3f5d1f46.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Dev notes for Java" class="md-header__button md-logo" aria-label="Dev notes for Java" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M16.5 6.08s-6.84 1.71-3.56 5.48c.97 1.11-.25 2.11-.25 2.11s2.45-1.25 1.31-2.85c-1.06-1.47-1.86-2.2 2.5-4.74m-4.47 1.2C16.08 4.08 14 2 14 2c.84 3.3-2.96 4.3-4.33 6.36-.94 1.4.46 2.91 2.33 4.64-.71-1.7-3.22-3.16.03-5.72M9.37 17.47c-3.08.86 1.88 2.63 5.79.96-.38-.15-.75-.33-1.1-.54-1.36.31-2.76.37-4.14.18-1.31-.16-.55-.6-.55-.6m5.32-1.68c-1.75.38-3.56.47-5.34.26-1.31-.13-.45-.77-.45-.77-3.4 1.13 1.88 2.4 6.6 1.02-.29-.11-.57-.3-.81-.51m3.42 3.3s.57.47-.61.83c-2.28.68-9.43.89-11.41.03-.71-.31.63-.74 1.05-.83.23-.06.46-.08.69-.08-.79-.54-5.13 1.1-2.19 1.56 7.97 1.3 14.54-.6 12.47-1.51m-2.74-4.86c.29-.19.6-.35.92-.49 0 0-1.51.26-3.02.4-1.6.16-3.21.18-4.81.06-2.35-.31 1.29-1.2 1.29-1.2-1.1 0-2.18.26-3.16.75-2.05 1 5.1 1.45 8.78.48m.9 2.42c-.02.04-.04.07-.08.1 5.01-1.31 3.17-4.64.77-3.81-.13.06-.24.14-.31.25.14-.05.28-.09.43-.12 1.2-.24 2.92 1.63-.81 3.58m.13 4.61c-3.01.52-6.09.56-9.12.14 0 0 .46.38 2.81.53 3.6.23 9.13-.13 9.26-1.83.03.01-.23.65-2.95 1.16z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Dev notes for Java </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 使用 Barriers 和 Latches 控制并发的应用程序 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/xkx9431/dev-notes-java/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> dev-notes-java </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../jvm/ class=md-tabs__link> JVM </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Concurrency </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Dev notes for Java" class="md-nav__button md-logo" aria-label="Dev notes for Java" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M16.5 6.08s-6.84 1.71-3.56 5.48c.97 1.11-.25 2.11-.25 2.11s2.45-1.25 1.31-2.85c-1.06-1.47-1.86-2.2 2.5-4.74m-4.47 1.2C16.08 4.08 14 2 14 2c.84 3.3-2.96 4.3-4.33 6.36-.94 1.4.46 2.91 2.33 4.64-.71-1.7-3.22-3.16.03-5.72M9.37 17.47c-3.08.86 1.88 2.63 5.79.96-.38-.15-.75-.33-1.1-.54-1.36.31-2.76.37-4.14.18-1.31-.16-.55-.6-.55-.6m5.32-1.68c-1.75.38-3.56.47-5.34.26-1.31-.13-.45-.77-.45-.77-3.4 1.13 1.88 2.4 6.6 1.02-.29-.11-.57-.3-.81-.51m3.42 3.3s.57.47-.61.83c-2.28.68-9.43.89-11.41.03-.71-.31.63-.74 1.05-.83.23-.06.46-.08.69-.08-.79-.54-5.13 1.1-2.19 1.56 7.97 1.3 14.54-.6 12.47-1.51m-2.74-4.86c.29-.19.6-.35.92-.49 0 0-1.51.26-3.02.4-1.6.16-3.21.18-4.81.06-2.35-.31 1.29-1.2 1.29-1.2-1.1 0-2.18.26-3.16.75-2.05 1 5.1 1.45 8.78.48m.9 2.42c-.02.04-.04.07-.08.1 5.01-1.31 3.17-4.64.77-3.81-.13.06-.24.14-.31.25.14-.05.28-.09.43-.12 1.2-.24 2.92 1.63-.81 3.58m.13 4.61c-3.01.52-6.09.56-9.12.14 0 0 .46.38 2.81.53 3.6.23 9.13-.13 9.26-1.83.03.01-.23.65-2.95 1.16z"/></svg> </a> Dev notes for Java </label> <div class=md-nav__source> <a href=https://github.com/xkx9431/dev-notes-java/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> dev-notes-java </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <div class="md-nav__link md-nav__link--index "> <a href=../../jvm/ >JVM</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=JVM data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Memory Management <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Memory Management" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Memory Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jvm/mm-overview/ class=md-nav__link> Memory Management </a> </li> <li class=md-nav__item> <a href=../../jvm/mm-introduction/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../jvm/mm-gc-works-internals/ class=md-nav__link> GC Internals </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >Concurrency</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Concurrency data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Concurrency </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2> 高级Java并发模式 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=高级Java并发模式 data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 高级Java并发模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../cp-overview/ class=md-nav__link> 高级Java并发模式 </a> </li> <li class=md-nav__item> <a href=../excutor-future-callable/ class=md-nav__link> Executor Pattern, Futures and Callables </a> </li> <li class=md-nav__item> <a href=../lock-sema-pro-con/ class=md-nav__link> 在生产者/消费者模式中使用锁和semaphores </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 使用 Barriers 和 Latches 控制并发的应用程序 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 使用 Barriers 和 Latches 控制并发的应用程序 </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 在线程间共享任务并合并结果 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 创建可调用任务并设置障碍 </a> </li> <li class=md-nav__item> <a href=#cyclicbarrier class=md-nav__link> CyclicBarrier模式 </a> </li> <li class=md-nav__item> <a href=#cyclicbarrier_1 class=md-nav__link> CyclicBarrier 总结 </a> </li> <li class=md-nav__item> <a href=#latch-barrier class=md-nav__link> 锁存器(Latch)，一个无法重置的障碍物( Barrier ) </a> <nav class=md-nav aria-label="锁存器(Latch)，一个无法重置的障碍物( Barrier )"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#countdownlatch class=md-nav__link> 倒计时锁存器 (CountdownLatch) </a> </li> <li class=md-nav__item> <a href=#countdownlatch_1 class=md-nav__link> CountDownLatch的实践 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 编码实践 </a> <nav class=md-nav aria-label=编码实践> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-cyclicbarrier class=md-nav__link> 1. 带回调任务的CyclicBarrier </a> </li> <li class=md-nav__item> <a href=#2-executorservicetimeout class=md-nav__link> 2. 设置ExecutorService，使用TimeOut </a> </li> <li class=md-nav__item> <a href=#3future class=md-nav__link> 3.future超时和任务取消 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../cas-atomic/ class=md-nav__link> 了解 CAS 和原子变量 </a> </li> <li class=md-nav__item> <a href=../concurrent-collections/ class=md-nav__link> Concurrent Collections and Maps </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 在线程间共享任务并合并结果 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 创建可调用任务并设置障碍 </a> </li> <li class=md-nav__item> <a href=#cyclicbarrier class=md-nav__link> CyclicBarrier模式 </a> </li> <li class=md-nav__item> <a href=#cyclicbarrier_1 class=md-nav__link> CyclicBarrier 总结 </a> </li> <li class=md-nav__item> <a href=#latch-barrier class=md-nav__link> 锁存器(Latch)，一个无法重置的障碍物( Barrier ) </a> <nav class=md-nav aria-label="锁存器(Latch)，一个无法重置的障碍物( Barrier )"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#countdownlatch class=md-nav__link> 倒计时锁存器 (CountdownLatch) </a> </li> <li class=md-nav__item> <a href=#countdownlatch_1 class=md-nav__link> CountDownLatch的实践 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 编码实践 </a> <nav class=md-nav aria-label=编码实践> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-cyclicbarrier class=md-nav__link> 1. 带回调任务的CyclicBarrier </a> </li> <li class=md-nav__item> <a href=#2-executorservicetimeout class=md-nav__link> 2. 设置ExecutorService，使用TimeOut </a> </li> <li class=md-nav__item> <a href=#3future class=md-nav__link> 3.future超时和任务取消 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/xkx9431/dev-notes-java/edit/main/docs/concurrency/barriers-latches.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>使用 Barriers 和 Latches 控制并发的应用程序</h1> <p>使用Barriers 和锁存器( latches)控制并发应用程序。让我们快速浏览一下本文agenda。我们将会讨论另外两个并发原语。在上一个模块中，我们看到了锁、读写锁和信号量。在这里，我们将看到Barriers 和latches。Barriers 的作用是让几个任务互相等待，然后触发一个后续的任务或动作，然后重置系统，让它可以再次运行。出于这个原因，这个Barriers 被称为CyclicBarrier。latches的工作方式几乎相同，主要区别在于它不重置。一旦锁存器被打开，它就不能再被关闭。下面会详细讲述细节。</p> <div class="admonition important"> <p class=admonition-title>Important</p> </div> <ul> <li>The <strong>barrier</strong>: to have several tasks waitfor each other</li> <li>The <strong>latch</strong>: to count down operationsand let a task start</li> </ul> <h4 id=_1>在线程间共享任务并合并结果<a class=headerlink href=#_1 title="Permanent link">&para;</a></h4> <p>让我们先来谈谈障碍。假设我们需要计算一些繁重的计算，并且我们想在几个线程之间分享这个计算。这是一个非常经典的用例。我们可以做的是把我们的数据集分给几个线程。每个线程都有一个子任务，我们所期望的是每个线程都能在我们的CPU的特定调用下执行。当所有的线程都完成后，我们需要做的是收集所有的计算结果并将其合并，所以我们需要一些后续的任务被触发来完成这个合并操作。让我们举一个非常经典的例子，寻找某一数值以内的素数。这里我们有192个数字需要检查。在这一点上你可以相信我。这里有相应的素数。如果我们以经典的方式启动这个任务，只有一个线程在工作，我们的CPU只有一个核心在做这个计算。当然，现在我们的CPU上有更多的一个核心。在核心I5或核心I7上，有4个物理核心和4个逻辑核心，所以我们应该能够比这快得多。</p> <p><img alt=find-prim-num src=../../images/concurrency/find_prim_num.png></p> <p>怎样才能做到这一点呢？ 我们可以把这个数据集分成四组，并把每组送到我们CPU的一个核心上。因此，第一个核心将在自己的组上找到素数，然后是第二个，然后是第三个，然后是第四个。现在，所有这些核心完全在同一时间结束计算的可能性非常小。它们要做的计算并不完全相同。它们可能会被操作系统打断来联系其他任务，所以它们不会在同一时间结束。但是一旦它们都完成了计算，我们需要做的是收集所有的部分结果，并将它们添加到结果列表中，以计算出这次计算的最终结果。所以一旦所有的事情都完成了，我们需要触发这种回调任务来结束计算。那么，我们需要从这个API中得到什么呢？首先，我们需要一种方法将计算分布在几个线程上，我们需要知道所有的线程什么时候完成了他们的任务，这样我们就可以在那一刻启动一个回调，一个后处理任务。</p> <h4 id=_2>创建可调用任务并设置障碍<a class=headerlink href=#_2 title="Permanent link">&para;</a></h4> <p>让我们看看代码如何返回。首先，我们需要一个任务，它将接收一组数字，并返回这个任务在这组数字中找到的素数集合。这个任务可以用一个可调用的接口来实现，这个接口我们在本课程的第一个模块中已经看到了。而我们将使用另一个叫做<code>CyclicBarrier</code>的对象。我们刚刚写的可调用程序将被启动数次，有不同的输入集，每个可调用程序将在自己的线程中并行启动。现在，我们需要知道所有的任务何时完成，为此，我们将使用这个<code>CyclicBarrier</code>对象。传递给这个对象的构造的参数是将被启动的任务的数量，屏障将控制这些任务。这个<code>CyclicBarrier</code>类型实际上是<code>java.util.concurrent</code>包的一个具体类，是j<code>ava.util.concurrent</code> API的一部分。</p> <div class=highlight><pre><span></span><code>    <span class=c1>// 01 </span>
    <span class=n>Callable</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>task</span><span class=o>=</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>findPrimes</span><span class=p>(</span><span class=n>inputSet</span><span class=p>);</span>

    <span class=c1>// 02 </span>
    <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=o>=</span><span class=n>newCyclicBarrier</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>

    <span class=c1>// 03</span>
    <span class=n>Callable</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>task</span><span class=o>=</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>{</span>
        <span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>result</span><span class=o>=</span> <span class=n>findPrimes</span><span class=p>(</span><span class=n>inputSet</span><span class=p>);</span>
        <span class=k>try</span><span class=p>{</span>
            <span class=n>barrier</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=c1>// Blocks until everybody is ready</span>
        <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=p>...</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>
</code></pre></div> <p><img alt="barriers internal" src=../../images/concurrency/barriers_internal.png></p> <h4 id=cyclicbarrier>CyclicBarrier模式<a class=headerlink href=#cyclicbarrier title="Permanent link">&para;</a></h4> <p>让我们看看这个任务的完整模式。所以我们将调用这个findPrimes方法，这个方法将从输入的集合中提取素数，一旦这个工作完成，一，结果被计算出来，我们将调用这个<code>barrier.await</code>方法，这个await方法将阻塞，直到所有人都准备好了，也就是我们刚刚返回的所有可调用程序都完成计算。这就是我们可以用来告诉可调用程序等待屏障打开的模式。事实上，这个 await 调用会阻塞，直到不同的线程对它进行了4次调用，4是我们在建立这个屏障时作为参数传递的数字。那么，它是如何精确工作的呢？我们在主线程中创建了四个可调用对象和一个屏障对象。所有这些可调用程序都被传递给我们在<code>Executor</code>模式中看到的<code>executor.submit</code>方法。它们将在<code>ExecutorService</code>中被执行，屏障暂时被关闭，这是它被创建时的默认状态。所有这些任务都将计算数据集，我们都调用这个障碍对象的等待方法。<strong>现在这个屏障对象将计算这个等待方法被调用了多少次，当这个调用次数与这个屏障被创建的次数一致时，它将打开并让线程继续执行</strong>。之后，我们可以设置一个回调任务，当屏障被打开时就会被触发。</p> <p>看一下代码。我们将创建一个Worker类，实现<code>List&lt;Integer&gt;</code>的Callable。在这个类中，我们有两个字段，首先是inputList，这个worker应该在其中找到质数和我们刚刚谈到的障碍。可调用接口的调用方法只是做我们在文提到的。它在输入列表中找到质数，然后调用屏障的等待方法。这是主线程的代码。首先，我们在四个任务上创建一个CyclicBarrier。当然，我们需要一个有适当数量线程的ExecutorService。我们需要多少个工作者就创建多少个，可能是四个工作者，因为我们有一个屏障和四个任务。我们把工人一个一个地提交给这个ExecutorService，得到一个Future，然后从不同的Future中得到结果，并把它们汇集到最终结果中。</p> <p><div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Worker</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=p>{</span>
    <span class=kd>private</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>inputList</span><span class=p>;</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>Worker</span><span class=p>(</span><span class=n>CyclicBarrierbarrier</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=n>inputList</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>barrier</span><span class=o>=</span> <span class=n>barrier</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=na>inputList</span><span class=o>=</span> <span class=n>inputList</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=nf>call</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>findPrimes</span><span class=p>(</span><span class=n>inputList</span><span class=p>);</span>
        <span class=k>try</span><span class=p>{</span>
            <span class=n>barrier</span><span class=p>.</span><span class=na>await</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span><span class=o>|</span> <span class=n>BrokenBarrierExceptione</span><span class=p>){</span>
        <span class=c1>// Error handling</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

    <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
    <span class=n>ExecutorService</span> <span class=n>service</span><span class=o>=</span> <span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
    <span class=n>Worker</span> <span class=n>worker1</span><span class=o>=</span> <span class=k>new</span> <span class=n>Worker</span><span class=p>(</span><span class=n>barrier</span><span class=p>,</span><span class=n>inputList1</span><span class=p>);</span>
    <span class=c1>// More workers</span>
    <span class=n>Future</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>future1</span><span class=o>=</span> <span class=n>service</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>worker1</span><span class=p>);</span>
    <span class=c1>// More submissions</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>finalResult</span><span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>future1</span><span class=p>.</span><span class=na>get</span><span class=p>());</span>
    <span class=n>finalResult</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>future2</span><span class=p>.</span><span class=na>get</span><span class=p>());</span>
    <span class=c1>// More results</span>
</code></pre></div> 我们刚刚看到，这个await调用是一个阻塞调用。现在，这个屏障API的设计理念与我们在前一个模块中看到的前几个API相同，主要是锁和信号灯。事实上，我们有两个版本的await方法，一个是无限期阻塞的，一个是可以超时的，假设它再次被阻塞，然后在屏障没有打开的情况下例外地返回一个InterruptedException。一旦打开，屏障通常会被重置，也就是说它将会打开，让线程通过，然后再关闭。屏障上有一个重置方法，所以我们可以在屏障上手动调用重置。它将会打开屏障，但会例外地打开它。所以所有等待的线程，所有在这个屏障上等待的任务在这种情况下都会抛出一个BrokenBarrierException。在其他情况下，BrokenBarrierException也会被抛出。如果一个线程在等待屏障时被打断，它就会被抛出，所以打断一个正在等待某个屏障的线程会导致其他线程抛出这个BrokenBarrierException，如果屏障被手动重置，就像我们刚才看到的，当一些线程在等待屏障打开时，它也会被抛出。</p> <div class="admonition notes"> <p class=admonition-title>Notes</p> <p>The await() call is blocking<br> There are two versions: <br> - <code>await()</code><br> - <code>await(time, timeUnit)</code><br> Once opened a barrier is normally <strong>reset</strong><br> The <code>reset()</code> method<br> resets the barrier exceptionnally, causing the waiting tasks to throw a <code>BrokenBarrierException</code> </p> </div> <h4 id=cyclicbarrier_1>CyclicBarrier 总结<a class=headerlink href=#cyclicbarrier_1 title="Permanent link">&para;</a></h4> <p>现在让我们快速总结一下我们在这个CyclicBarrier上看到的东西。CyclicBarrier是一个工具，我们可以用它来同步几个线程，当它们达到一个共同点时，让它们继续进行工作。CyclicBarrier在创建时是关闭的，当所有的线程都达到这个共同点时就会打开，然后会再次关闭，允许循环计算。它也可以被手动重置，但在这种情况下，这个屏障上的等待线程会抛出一个BrokenBarrierException。最后，还可以对等待屏障打开的线程设置超时。因此，如果我们的计算出了问题，系统没有被阻塞，线程仍然可以被释放，当然，会出现InterruptedException。</p> <div class="admonition notes"> <p class=admonition-title>Notes</p> <p>A BrokenBarrierExceptionis raised if:<br> - a thread is interruptedwhile waiting<br> - the barrier is resetwhile some threads are waiting</p> </div> <h3 id=latch-barrier>锁存器(Latch)，一个无法重置的障碍物( Barrier )<a class=headerlink href=#latch-barrier title="Permanent link">&para;</a></h3> <p>现在让我们来谈谈latches。锁存器是与障碍物密切相关的对象，但它是不一样的，我们将看到它们之间的区别。让我们来看看一个新的用例。我们需要启动我们的应用，这个应用是一个相当复杂的应用。它依赖于许多服务，比如AuthenticationService、访问数据库的DataService、处理客户订单的OrderService，可能还有很多。当然，我们需要确保在我们启动主程序之前，所有这些服务的属性都已启动。所以在为客户提供服务之前，我们的应用程序需要确保所有这些资源都被正确地初始化了。看起来这对CyclicBarrier是个问题。问题是，一旦所有的服务都可用，一旦它们的所有属性都启动了，我们就需要启动我们的应用程序，但我们不希望屏障被重置。我们不希望屏障再次关闭，因为它可能会阻止一切，系统会觉得有些服务没有被正确启动。因此，在这种情况下，我们不能使用这个对象，因为这个障碍是循环的。事实上，我们需要的是一种一旦打开就不能再关闭的屏障，这正是我们现在要看到的这个叫做倒计时锁的新对象的工作。</p> <h4 id=countdownlatch>倒计时锁存器 (CountdownLatch)<a class=headerlink href=#countdownlatch title="Permanent link">&para;</a></h4> <p>CountdownLatch的工作原理与CyclicBarrier几乎相同。假设我们在主线程中有三个可调用的任务和一个Latch对象。我们把所有东西都传给ExecutorService，我们的任务就会执行。在某些时候，我们所有的任务都将在锁存器上等待，这将产生与屏障相同的效果。它将打开latches，让任务继续执行。但最大的区别是，锁存器并不重置。它不会再次关闭。</p> <h4 id=countdownlatch_1>CountDownLatch的实践<a class=headerlink href=#countdownlatch_1 title="Permanent link">&para;</a></h4> <p>我们创建一个ServiceWorker。这个worker的任务是启动一个给定的服务，考虑一下AuthenticationService之类的。它实现了可调用性。当我创建这样一个工作者时，我向它传递一个给定的锁存器和我想启动的服务，这个可调用接口的调用方法实现做了两件事。首先，它调用该服务的init方法，该方法将正确初始化该服务。这可能需要一些时间，特别是如果我有网络访问之类的。而一旦完成，我就要调用这个Latch对象的倒计时方法。在主线程方面，我创建了这个CountDownLatch对象，有三个服务要启动。这个CountDownLatch类是一个来自Java.util.Concurrent包的类。然后是有四个线程的ExecutorService。然后我可以根据我的需要创建尽可能多的工作者来初始化我的服务。在这里，我假设我有三个服务。我将在我的Executor中提交这些工作者。这个Executor将执行它们，然后我所要做的就是通过调用它的await方法来等待这个latch的打开。这个等待方法将被阻塞，直到锁存器的计数达到0，当这种情况发生时，我可以调用我的server.start方法来启动我的整个服务器，这将触发对客户的服务。现在我使用了带有超时方法的await。它将只阻塞10秒，我想这足够启动我的应用程序了。</p> <p><div class=highlight><pre><span></span><code>    <span class=c1>//Service worker</span>
    <span class=kd>public</span> <span class=kd>class</span> <span class=nc>ServiceWorker</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=p>{</span>
        <span class=kd>private</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=p>;</span>
        <span class=kd>private</span> <span class=n>Service</span> <span class=n>service</span><span class=p>;</span>
        <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>Worker</span><span class=p>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=p>,</span> <span class=n>Service</span> <span class=n>service</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=na>latch</span><span class=o>=</span> <span class=n>latch</span><span class=p>;</span>
            <span class=k>this</span><span class=p>.</span><span class=na>service</span><span class=o>=</span> <span class=n>service</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>call</span><span class=p>()</span> <span class=p>{</span>
            <span class=n>service</span><span class=p>.</span><span class=na>init</span><span class=p>();</span>
            <span class=n>latch</span><span class=p>.</span><span class=na>countDown</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>//  user logic</span>
    <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
    <span class=n>ExecutorService</span> <span class=n>executor</span><span class=o>=</span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
    <span class=n>ServiceWorker</span> <span class=n>worker1</span><span class=o>=</span> <span class=k>new</span> <span class=n>ServiceWorker</span><span class=p>(</span><span class=n>latch</span><span class=p>,</span><span class=n>dataService</span><span class=p>);</span>
    <span class=c1>// More workers</span>
    <span class=n>Future</span><span class=o>&lt;</span><span class=n>Boolean</span><span class=o>&gt;</span> <span class=n>future1</span><span class=o>=</span> <span class=n>executor</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>worker1</span><span class=p>);</span>
    <span class=c1>// More submissions</span>
    <span class=k>try</span><span class=p>{</span>
        <span class=n>latch</span><span class=p>.</span><span class=na>await</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span> <span class=c1>// blocks until the count reaches 0</span>
        <span class=n>server</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>InterruptedExceptione</span><span class=p>){</span>
        <span class=c1>// Error handling</span>
    <span class=p>}</span>
</code></pre></div> 所以我们现在可以把这个简单的对象CountDownLatch包装起来。这个锁存器只是一个工具，用来检查不同的线程是否正确完成了他们的任务。一旦完成，我们就可以在最后一个完成的任务上同步开始后续的任务。与CyclicBarrier不同的是，CountDownLatch一旦打开，就不能再关闭，所以它是控制应用程序启动的一个非常好的工具。</p> <div class="admonition notes"> <p class=admonition-title>Notes</p> <p>CountDownLatch:<br> 检查不同线程是否完成任务的工具<br> 最后一个完成的任务上同步开始后续的任务<br> 一旦打开CountDownLatch，就不能再关闭</p> </div> <h3 id=_3>编码实践<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <h4 id=1-cyclicbarrier>1. 带回调任务的CyclicBarrier<a class=headerlink href=#1-cyclicbarrier title="Permanent link">&para;</a></h4> <p>以下是一个完整的CyclicBarrier例子，其中有一个正在运行的CyclicBarrier，然后几个线程将做一些事情，触发这个屏障，并最终打开屏障触发一个调用。 假设我们有四个朋友决定一起去看电影，他们也想一起排队，但当然，他们住在城市的不同地方，所以他们决定在附近的咖啡馆见面，然后一起去看电影。所以朋友是由一个Callable建模的。Callable接口的调用方法如下。朋友到达咖啡馆需要一个随机时间。当它到达咖啡馆时，它只是打印出这样的信息，我刚刚到达，我正在等待其他人，然后等待其他人意味着调用这个障碍。 等待方法。正如我们在幻灯片中看到的，这个方法的调用是阻塞的，直到对它的调用达到一个设定的数量。一旦达到这个调用的数量，屏障就会打开，代码就可以继续，让我们去电影院，然后返回ok。我们将如何使用这段代码呢？让我们在四个线程上创建一个执行者服务，在4的计数上创建一个CyclicBarrier，并创建4个朋友，当然，他们将共享同一个屏障对象。我们将把这些可调用对象提交给同一个执行者服务，并在这个期货列表中积累期货。然后我们将调用每个期货的get方法，如果执行过程中出现异常，则打印出任何信息。让我们运行这段代码。它按预期执行。所有四个朋友将在随机时间到达咖啡馆，然后当这四个朋友都在那里时，他们将一起去电影院。请注意，我们还可以传递一个任务，在障碍物打开之前执行。这个任务实际上是一个可运行的任务，所以让我们直接打印出一个消息Barrier Opening并执行这个结果。而事实上，这个任务已经在我们等待的等待方法的线程释放之前被执行了。 <div class=highlight><pre><span></span><code><span class=c1>// package org.paumard.barriers;</span>

<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.Random</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Callable</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.CyclicBarrier</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutionException</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutorService</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Executors</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Future</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeoutException</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>BarrierInAction</span> <span class=p>{</span>


    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>

        <span class=kd>class</span> <span class=nc>Friend</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=p>{</span>

            <span class=kd>private</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>;</span>

            <span class=kd>public</span> <span class=nf>Friend</span><span class=p>(</span><span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>this</span><span class=p>.</span><span class=na>barrier</span> <span class=o>=</span> <span class=n>barrier</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kd>public</span> <span class=n>String</span> <span class=nf>call</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>

                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
                    <span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>((</span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=mi>100</span><span class=p>));</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;I just arrived, waiting for the others...&quot;</span><span class=p>);</span>

                    <span class=n>barrier</span><span class=p>.</span><span class=na>await</span><span class=p>();</span>

                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Let&#39;s go to the cinema!&quot;</span><span class=p>);</span>
                    <span class=k>return</span> <span class=s>&quot;ok&quot;</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Interrupted&quot;</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>return</span> <span class=s>&quot;nok&quot;</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>

        <span class=n>CyclicBarrier</span> <span class=n>barrier</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Barrier openning&quot;</span><span class=p>));</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>futures</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span> <span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span> <span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Friend</span> <span class=n>friend</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Friend</span><span class=p>(</span><span class=n>barrier</span><span class=p>);</span>
                <span class=n>futures</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>friend</span><span class=p>));</span>
            <span class=p>}</span>

            <span class=n>futures</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span>
                <span class=n>future</span> <span class=o>-&gt;</span> <span class=p>{</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>               
                        <span class=c1>// future.get(200, TimeUnit.MILLISECONDS);              </span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>ExecutionException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
                    <span class=c1>// } catch (TimeoutException e) {</span>
                    <span class=c1>//  System.out.println(&quot;Timed out&quot;);</span>
                    <span class=c1>//  future.cancel(true);</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>);</span>

        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>executorService</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <div class=highlight><pre><span></span><code>I just arrived, waiting for the others...
I just arrived, waiting for the others...
I just arrived, waiting for the others...
I just arrived, waiting for the others...
Barrier openning
Let&#39;s go to the cinema!
Let&#39;s go to the cinema!
Let&#39;s go to the cinema!
Let&#39;s go to the cinema!
</code></pre></div></p> <h4 id=2-executorservicetimeout>2. 设置ExecutorService，使用TimeOut<a class=headerlink href=#2-executorservicetimeout title="Permanent link">&para;</a></h4> <p>所以我们刚刚看到了一切正常的情况。现在让我们看看如何撤销异常和超时。让我们看看第一个可能出错的情况。所有的可调用程序都在我们的ExecutorService的一个给定的线程中执行。这个等待方法阻塞了这些线程，但它们并没有释放它们。因此，如果我在CyclicBarrier上的计数是4，我需要在我的Executor中至少有4个线程可用。如果不是这样的话，就意味着这个障碍物永远不会打开。让我们来看看。让我们在这个执行器中放入两个线程。第一个可调用的两个线程将被正确执行，并等待屏障打开，但由于这个Executor没有任何可用的线程来执行另外两个任务，它们将永远不会被执行，这个屏障也将永远不会打开。现在，我们如何处理这个障碍永远不会打开的事实，或者至少，需要很长的时间，太多的时间才能正常打开。好吧，这个await方法有几个版本，其中有一个版本需要一个超时作为参数。让我们把这个超时设置为一个高值，比如5秒，看看会发生什么。我们所期待的是以下情况。我们有两个任务将被正确执行，所以这个await方法将为它们执行，但其他两个任务永远不会被执行。所以在某个时候，这个await方法会在5秒后抛出一个超时异常。这个超时异常将在future的这个get方法中被看到，并且这个障碍将被打破。让我们来执行这段代码。所以这就是执行的两个第一个任务，你可以看到一个超时异常和一个BrokenBarrierException一起被引发。事实上，第一个超时的任务关闭了等待方法上的另一个等待任务，抛出了这个BrokenBarrierException。所以这两个任务已经失败了。我们的ExecutorService的两个相应的线程已经被释放，它们变得可以执行两个等待任务。所以这就是我们在这里看到的，当这两个等待任务到达障碍和等待方法时，由于障碍被打破，立即抛出了BrokenBarrierException。所以在这里我们看到了两件事，如何在这个等待方法上设置一个超时。第一个超时到达的时候会抛出一个TimeoutException，可以在这个get方法中捕获。这将导致障碍的中断，所以所有对这个等待方法的其他调用将立即抛出一个BrokenBarrierException。</p> <div class=highlight><pre><span></span><code><span class=c1>// package org.paumard.barriers;</span>

<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.Random</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Callable</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.CyclicBarrier</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutionException</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutorService</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Executors</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Future</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeoutException</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>BarrierInAction</span> <span class=p>{</span>


    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>

        <span class=kd>class</span> <span class=nc>Friend</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=p>{</span>

            <span class=kd>private</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>;</span>

            <span class=kd>public</span> <span class=nf>Friend</span><span class=p>(</span><span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>this</span><span class=p>.</span><span class=na>barrier</span> <span class=o>=</span> <span class=n>barrier</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kd>public</span> <span class=n>String</span> <span class=nf>call</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>

                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
                    <span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>((</span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=mi>100</span><span class=p>));</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;I just arrived, waiting for the others...&quot;</span><span class=p>);</span>

                    <span class=n>barrier</span><span class=p>.</span><span class=na>await</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span> <span class=c1>// add time exception</span>

                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Let&#39;s go to the cinema!&quot;</span><span class=p>);</span>
                    <span class=k>return</span> <span class=s>&quot;ok&quot;</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Interrupted&quot;</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>return</span> <span class=s>&quot;nok&quot;</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>

        <span class=n>CyclicBarrier</span> <span class=n>barrier</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Barrier openning&quot;</span><span class=p>));</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>futures</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span> <span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span> <span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Friend</span> <span class=n>friend</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Friend</span><span class=p>(</span><span class=n>barrier</span><span class=p>);</span>
                <span class=n>futures</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>friend</span><span class=p>));</span>
            <span class=p>}</span>

            <span class=n>futures</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span>
                <span class=n>future</span> <span class=o>-&gt;</span> <span class=p>{</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>               
                        <span class=c1>// future.get(200, TimeUnit.MILLISECONDS);              </span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>ExecutionException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
                    <span class=c1>// } catch (TimeoutException e) {</span>
                    <span class=c1>//  System.out.println(&quot;Timed out&quot;);</span>
                    <span class=c1>//  future.cancel(true);</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>);</span>

        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>executorService</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>输出： <div class=highlight><pre><span></span><code>I just arrived, waiting for the others...
I just arrived, waiting for the others...
java.util.concurrent.TimeoutException
java.util.concurrent.BrokenBarrierException
I just arrived, waiting for the others...
java.util.concurrent.BrokenBarrierException
I just arrived, waiting for the others...
java.util.concurrent.BrokenBarrierException
</code></pre></div></p> <h4 id=3future>3.future超时和任务取消<a class=headerlink href=#3future title="Permanent link">&para;</a></h4> <p>第二种处理方式如下。我们已经从这个await调用中删除了超时，我们可以在这个future.get调用上再放一个超时。让我们把它放在200 MILLISECONDS。这个版本的get方法可以抛出一个TimeoutException，所以我们要在周围的try TimeoutException附近添加一个catch，这里只是打印出Timed out。让我们运行这段代码。这里我们可以看到，我们的问题只得到了部分解决。为什么？因为我们所有的future都已经超时了，所以我们的主线程不再等待任何结果了。但是我们的任务仍然在等待屏障打开，我们的两个未执行的任务仍然在ExecutorService中等待，我们可以看到这里JVM仍然在运行，因为线程仍然在ExecutorService中运行，执行任务。所以给这个get方法计时并不总是取消正在运行的任务，即相应的运行任务，在这种情况下，它只是一个部分解决方案。用这个解决方案完全处理这种情况的正确方法是，一旦抛出这个TimeoutException，通过调用future.cancel取消相应的任务，并传递true，因为我们要中断当前运行的任务和在ExecutorService中等待可用线程的任务。如果我们按原样运行这段代码，在我们的应用程序已经正常退出的情况下，它将起作用，所以这意味着ExecutorService已经被关闭，所有的任务都被取消了，但如果我们想更准确地看到它，我们需要用一个try catch来包围这段代码，在这里捕获InterruptedException，打印出一个消息，比如说Interrupted，并返回nok。如果我们到达代码的这一点，让我们再次运行这段代码，现在我们可以看到每个任务都超时了，然后被取消方法的调用打断。 <div class=highlight><pre><span></span><code><span class=c1>// package org.xkx.barriers;</span>

<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.Random</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Callable</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.CyclicBarrier</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutionException</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.ExecutorService</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Executors</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.Future</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.util.concurrent.TimeoutException</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>BarrierInAction</span> <span class=p>{</span>


    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>

        <span class=kd>class</span> <span class=nc>Friend</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=p>{</span>

            <span class=kd>private</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>;</span>

            <span class=kd>public</span> <span class=nf>Friend</span><span class=p>(</span><span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>this</span><span class=p>.</span><span class=na>barrier</span> <span class=o>=</span> <span class=n>barrier</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kd>public</span> <span class=n>String</span> <span class=nf>call</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>

                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
                    <span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>((</span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=mi>100</span><span class=p>));</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;I just arrived, waiting for the others...&quot;</span><span class=p>);</span>

                    <span class=n>barrier</span><span class=p>.</span><span class=na>await</span><span class=p>();</span>

                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Let&#39;s go to the cinema!&quot;</span><span class=p>);</span>
                    <span class=k>return</span> <span class=s>&quot;ok&quot;</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Interrupted&quot;</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>return</span> <span class=s>&quot;nok&quot;</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>

        <span class=n>CyclicBarrier</span> <span class=n>barrier</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Barrier openning&quot;</span><span class=p>));</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span> <span class=n>futures</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>

        <span class=k>try</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span> <span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span> <span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Friend</span> <span class=n>friend</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Friend</span><span class=p>(</span><span class=n>barrier</span><span class=p>);</span>
                <span class=n>futures</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>friend</span><span class=p>));</span>
            <span class=p>}</span>

            <span class=n>futures</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span>
                <span class=n>future</span> <span class=o>-&gt;</span> <span class=p>{</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span>             
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>ExecutionException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>TimeoutException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Timed out&quot;</span><span class=p>);</span>
                        <span class=c1>// future.cancel(true);</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>);</span>

        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=n>executorService</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></p> <p>输出 <div class=highlight><pre><span></span><code>Timed out
Timed out
Timed out
Timed out
I just arrived, waiting for the others...
I just arrived, waiting for the others...
</code></pre></div></p> <p>添加 <code>future.cancel(ture)</code></p> <div class=highlight><pre><span></span><code>I just arrived, waiting for the others...
Timed out
Interrupted
Timed out
Interrupted
Timed out
Interrupted
I just arrived, waiting for the others...
Timed out
</code></pre></div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../lock-sema-pro-con/ class="md-footer__link md-footer__link--prev" aria-label="Previous: 在生产者/消费者模式中使用锁和semaphores" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> 在生产者/消费者模式中使用锁和semaphores </div> </div> </a> <a href=../cas-atomic/ class="md-footer__link md-footer__link--next" aria-label="Next: 了解 CAS 和原子变量" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> 了解 CAS 和原子变量 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2021 XKX </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/xkx9431 target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://www.zhihu.com/people/triumphxu target=_blank rel=noopener title=www.zhihu.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"/></svg> </a> <a href=https://www.linkedin.com/in/%E5%87%AF%E6%97%8B-%E8%A8%B1-983884103/ target=_blank rel=noopener title=www.linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script> <script src=../../assets/javascripts/bundle.1e84347e.min.js></script> </body> </html>